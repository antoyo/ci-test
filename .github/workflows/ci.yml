name: CI

on:
  - push
  - pull_request

jobs:
  required-checks:
    runs-on: ubuntu-latest
    steps:
    - name: Wait for required checks
      uses: roryq/required-checks@master
      with:
        required_workflow_patterns: |
          - .*

  build:
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        libgccjit_version:
          - { gcc: "gcc-15.deb" }
          - { gcc: "gcc-15-without-int128.deb" }

    steps:
    - uses: actions/checkout@v4

    - name: Print artifact
      run: echo ${{ matrix.libgccjit_version.gcc }}

  duplicates:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: echo Duplicates

  # Summary job for the merge queue.
  # ALL THE PREVIOUS JOBS NEED TO BE ADDED TO THE `needs` SECTION OF THIS JOB!
  success:
    needs: [build, duplicates]
    # We need to ensure this job does *not* get skipped if its dependencies fail,
    # because a skipped job is considered a success by GitHub. So we have to
    # overwrite `if:`. We use `!cancelled()` to ensure the job does still not get run
    # when the workflow is canceled manually.
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      # Manually check the status of all dependencies. `if: failure()` does not work.
      - name: Conclusion
        run: |
          # Print the dependent jobs to see them in the CI log
          jq -C <<< '${{ toJson(needs) }}'
          # Check if all jobs that we depend on (in the needs array) were successful.
          jq --exit-status 'all(.result == "success")' <<< '${{ toJson(needs) }}'
